# 📋 Инструкция по запуску и деплою

## 🚀 1. Запуск двух сервисов сразу

### Через Docker (рекомендуется):
```bash
# Остановить старые контейнеры
docker-compose down

# Запустить оба сервиса
docker-compose up -d

# Или с пересборкой
docker-compose up --build -d

# Проверить статус
docker ps
```

### Через батник (Windows):
```bash
# Двойной клик по файлу
start_docker.bat
```

### Проверка работы:
- **Основное приложение**: http://localhost:5000
- **CRM сервис**: http://localhost:5001 (доступ ограничен по IP)

---

## 📤 2. Пуш на GitHub

### 🔧 Настройка перед пушем:

1. **Убедитесь что .env файлы НЕ попадут в Git:**
   ```bash
   git check-ignore crm_service/.env
   # Должно показать: crm_service/.env
   ```

2. **Проверьте статус:**
   ```bash
   git status
   # .env файлы не должны быть в списке
   ```

### 📁 A. Пуш только CRM сервиса:
```bash
# Добавить только CRM файлы
git add crm_service/config_secure.py
git add crm_service/secure_crm.py  
git add crm_service/README.md
git add crm_service/Dockerfile
git add crm_service/.env.example
git add crm_service/security.py

# Коммит
git commit -m "Add secure CRM microservice"

# Пуш
git push origin fix-image-collision
```

### 🏪 B. Пуш только основного сервиса:
```bash
# Добавить основные файлы
git add app.py
git add config.py
git add requirements.txt
git add models.py
git add templates/
git add static/

# Коммит
git commit -m "Update main retail application"

# Пуш
git push origin fix-image-collision
```

### 🔄 C. Пуш обоих сервисов:
```bash
# Добавить все безопасные файлы
git add .gitignore
git add requirements.txt
git add app.py
git add config.py
git add docker-compose.yml
git add Dockerfile
git add .dockerignore
git add SECURITY.md
git add ИНСТРУКЦИЯ.md

# CRM файлы (без .env!)
git add crm_service/config_secure.py
git add crm_service/secure_crm.py
git add crm_service/README.md
git add crm_service/Dockerfile
git add crm_service/.env.example

# Коммит
git commit -m "Complete secure retail site with CRM microservice

- Main app: PostgreSQL integration, Docker support
- CRM service: Secure with environment variables
- Security: No passwords in code, IP filtering
- Docker: Both services containerized"

# Пуш
git push origin fix-image-collision
```

---

## 🌐 3. Деплой основного сервиса на Heroku

### ⚠️ ВАЖНО: Только основное приложение! CRM НЕ деплоим!

### 🔧 A. Подготовка для Heroku:

1. **Создайте Procfile:**
   ```bash
   echo "web: gunicorn app:app" > Procfile
   ```

2. **Убедитесь что requirements.txt готов:**
   ```txt
   Flask==2.3.3
   Flask-SQLAlchemy>=2.5.0,<3.1.0
   SQLAlchemy>=1.4.0,<2.0.0
   Flask-Login==0.6.3
   Flask-WTF==1.1.1
   WTForms==3.0.1
   Flask-Migrate==4.0.5
   Werkzeug==2.3.7
   psycopg2-binary==2.9.7
   gunicorn==21.2.0
   # остальные зависимости...
   ```

### 🚀 B. Деплой на Heroku:

1. **Установите Heroku CLI** (если нет)

2. **Логин в Heroku:**
   ```bash
   heroku login
   ```

3. **Создайте приложение:**
   ```bash
   heroku create your-retail-site-name
   ```

4. **Добавьте PostgreSQL:**
   ```bash
   heroku addons:create heroku-postgresql:mini
   ```

5. **Настройте переменные окружения:**
   ```bash
   heroku config:set FLASK_ENV=production
   heroku config:set SECRET_KEY=your-production-secret-key
   ```

6. **Деплой:**
   ```bash
   git push heroku fix-image-collision:main
   ```

7. **Инициализация БД:**
   ```bash
   heroku run flask db upgrade
   ```

8. **Открыть приложение:**
   ```bash
   heroku open
   ```

### 🔍 C. Проверка и отладка:

```bash
# Логи приложения
heroku logs --tail

# Статус
heroku ps

# Переменные окружения
heroku config
```

---

## 📝 4. Быстрые команды

### Локальная разработка:
```bash
# Старт
docker-compose up -d

# Стоп  
docker-compose down

# Пересборка
docker-compose up --build

# Логи
docker-compose logs
```

### Git операции:
```bash
# Проверка статуса
git status

# Проверка что .env не попадет в Git
git check-ignore crm_service/.env

# Безопасный коммит (без паролей)
git add . --dry-run
```

### Heroku операции:
```bash
# Логи
heroku logs --tail

# Перезапуск
heroku restart

# Статус БД
heroku pg:info
```

---

## ⚠️ 5. Важные предупреждения

### 🔒 Безопасность:
- ❌ **НИКОГДА** не коммитьте `.env` файлы
- ❌ **НЕ** деплойте CRM сервис на Heroku
- ✅ Проверяйте `git status` перед каждым коммитом

### 🏗️ Архитектура:
- **Основное приложение** → Heroku (публично)
- **CRM сервис** → только локально (приватно)
- **База данных** → PostgreSQL (отдельно для каждого) 